# --- Stage 1: Build (Сборка внутри контейнера) ---
FROM gradle:8.11-jdk17 AS builder
WORKDIR /app
COPY . .
# Снова собираем внутри для чистоты и воспроизводимости
RUN ./gradlew clean build -x test

# --- Stage 2: Runtime (Минимальный образ для запуска) ---
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# Безопасность: работаем не от root
RUN addgroup -S nikitagrp && adduser -S nikita -G nikitagrp
USER nikita

# Копируем JAR, который мы только что собрали
# Имя файла может немного отличаться, поэтому используем маску *.jar
COPY --from=builder /app/build/libs/*.jar app_Nikita.jar

# Проверка работоспособности (требование Healthcheck)
HEALTHCHECK --interval=30s --timeout=3s \
  CMD wget -q --spider http://localhost:8080/actuator/health || exit 1

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app_Nikita.jar"]